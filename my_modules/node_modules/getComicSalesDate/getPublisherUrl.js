/**************************************************************************************************
 * モジュール名　:
 * 概要　　　　　:
 *************************************************************************************************/

// モジュール読み込み
var Q = require('q'),
    client = require('cheerio-httpcli'),
    CONST = require('getComicSalesDate/const');

function getPublisherUrl(){
  var _d = Q.defer();

  Q()
    // 出版社別ページURL取得
    .then(sendRequest)
    .fail(function(in_err){
      _d.reject(in_err);
    })
    .done(function(in_urlList){
      _d.resolve(in_urlList);
    });

  return _d.promise;
}

function sendRequest(){

  var _d = Q.defer();

  client.fetch(CONST.SALES_URL, {}, function(_e, $, _res) {
    if (!_e && _res.statusCode === 200) {
      // 取得したレスポンスから登録するコミックリストを取得する
      var _aryTargetUrl = [];
      $('table').find('a').each(function(){
        var _href = $(this).attr('href');
        if(_href.indexOf('ComicSyuppan') > 0){
          _aryTargetUrl.push(_href);
        }
      });
      if(0 < _aryTargetUrl.length){
        _d.resolve(_aryTargetUrl);
      }else{
      _d.reject('PublisherList is none');
      }
    }else{
      _d.reject('Bad Request');
    }
  });

  return _d.promise;
}

module.exports = getPublisherUrl;